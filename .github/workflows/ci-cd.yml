name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  client:
    name: üé® Client ‚Äî Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Cache client dependencies
        uses: actions/cache@v4
        with:
          path: client/node_modules
          key: ${{ runner.os }}-client-v2-${{ hashFiles('client/package-lock.json') }}

      - name: üõ†Ô∏è Install dependencies (client)
        working-directory: client
        run: npm ci

      # Only run if you have tests configured
      # - name: üß™ Run client unit tests 
      #   working-directory: client
      #   run: npm test

      - name: üèóÔ∏è Build client
        working-directory: client
        run: npm run build

      - name: ‚¨ÜÔ∏è Upload client dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-dist
          path: client/dist

  server:
    name: üíª Server ‚Äî Install and Test
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Cache server dependencies
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-server-v2-${{ hashFiles('server/package-lock.json') }}

      - name: üõ†Ô∏è Install dependencies (server)
        working-directory: server
        run: npm ci

      # Only run if you have tests configured
      # - name: üß™ Run server unit tests
      #   working-directory: server
      #   run: npm test

  build-and-push:
    name: üê≥ Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [client, server]
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚¨áÔ∏è Download client build artifact
        uses: actions/download-artifact@v4
        with:
          name: client-dist
          path: client/dist

      - name: üî§ Lowercase Repo Owner
        # This fixes the "invalid reference format" error
        run: |
          echo "REPO_OWNER=${GITHUB_REPOSITORY_OWNER,,}" >>${GITHUB_ENV}

      - name: üîë Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üèóÔ∏è Build and push client image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.REPO_OWNER }}/vvce-client:${{ github.sha }}
            ghcr.io/${{ env.REPO_OWNER }}/vvce-client:latest

      - name: üèóÔ∏è Build and push server image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.REPO_OWNER }}/vvce-server:${{ github.sha }}
            ghcr.io/${{ env.REPO_OWNER }}/vvce-server:latest

  deploy:
    name: üö¢ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: üîë Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: üñºÔ∏è Update deployments to use pushed images
        run: |
          # Convert owner to lowercase again for this job
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          CLIENT_IMAGE_TAG="ghcr.io/$REPO_OWNER/vvce-client:${{ github.sha }}"
          SERVER_IMAGE_TAG="ghcr.io/$REPO_OWNER/vvce-server:${{ github.sha }}"
          
          # Attempt to update images (|| true prevents failure if deployment doesn't exist yet)
          kubectl set image deployment/vvce-client vvce-client=$CLIENT_IMAGE_TAG --record || true
          kubectl set image deployment/vvce-server vvce-server=$SERVER_IMAGE_TAG --record || true

      - name: üöÄ Apply k8s manifests
        run: |
          # Pointing to the root 'k8s' folder found in your repo
          kubectl apply -f k8s/ --recursive
