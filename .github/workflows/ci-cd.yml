name: CI

on:
	push:
		branches: [ main ]
	pull_request:
		branches: [ main ]

permissions:
	contents: read
	packages: write

jobs:
	client:
		name: Client — Build
		runs-on: ubuntu-latest
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Use Node.js
				uses: actions/setup-node@v4
				with:
					node-version: '18'

			- name: Cache client dependencies
				uses: actions/cache@v4
				with:
					path: client/node_modules
					key: ${{ runner.os }}-client-${{ hashFiles('client/package.json') }}

			- name: Install dependencies (client)
				working-directory: client
				run: npm install

			- name: Build client
				working-directory: client
				run: npm run build

			- name: Upload client build artifact
				uses: actions/upload-artifact@v4
				with:
					name: client-dist
					path: client/dist

	server:
		name: Server — Install
		runs-on: ubuntu-latest
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Use Node.js
				uses: actions/setup-node@v4
				with:
					node-version: '18'

			- name: Cache server dependencies
				uses: actions/cache@v4
				with:
					path: server/node_modules
					key: ${{ runner.os }}-server-${{ hashFiles('server/package.json') }}

			- name: Install dependencies (server)
				working-directory: server
				run: npm install

			- name: Quick environment check
				working-directory: server
				run: |
					node -v
					npm -v

	build-and-push:
		name: Build and Push Docker Images
		runs-on: ubuntu-latest
		needs: [client, server]
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Log in to GitHub Container Registry
				uses: docker/login-action@v2
				with:
					registry: ghcr.io
					username: ${{ github.actor }}
					password: ${{ secrets.GITHUB_TOKEN }}

			- name: Build and push client image
				uses: docker/build-push-action@v5
				with:
					context: ./client
					file: ./client/Dockerfile
					push: true
					tags: |
						ghcr.io/${{ github.repository_owner }}/vvce-client:${{ github.sha }}
						ghcr.io/${{ github.repository_owner }}/vvce-client:latest

			- name: Build and push server image
				uses: docker/build-push-action@v5
				with:
					context: ./server
					file: ./server/Dockerfile
					push: true
					tags: |
						ghcr.io/${{ github.repository_owner }}/vvce-server:${{ github.sha }}
						ghcr.io/${{ github.repository_owner }}/vvce-server:latest

	deploy:
		name: Deploy to Kubernetes
		runs-on: ubuntu-latest
		needs: build-and-push
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Set up kubectl
				uses: azure/setup-kubectl@v3

			- name: Configure kubeconfig
				env:
					KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
				run: |
					echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config

			- name: Update deployments to use pushed images
				run: |
					kubectl set image deployment/vvce-client vvce-client=ghcr.io/${{ github.repository_owner }}/vvce-client:${{ github.sha }} --record || true
					kubectl set image deployment/vvce-server vvce-server=ghcr.io/${{ github.repository_owner }}/vvce-server:${{ github.sha }} --record || true

			- name: Apply k8s manifests (create/update)
				run: |
					kubectl apply -f client/k8s --recursive || true
					kubectl apply -f server/k8s --recursive || true


